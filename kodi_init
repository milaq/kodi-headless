#!/bin/bash

set -e
trap 'kill $(jobs -p) 2>/dev/null' EXIT

echo "======================================================="
if [ ! -e /config/userdata/advancedsettings.xml ]; then
  if [ ! -d /config/userdata ]; then
    mkdir /config/userdata
  fi
  cp /usr/local/share/kodi/advancedsettings.xml.default /config/userdata/advancedsettings.xml
  chown kodi. /config/userdata/advancedsettings.xml

  if [ ! -z $KODI_DBHOST ] && [ ! -z $KODI_DBUSER ] && [ ! -z $KODI_DBPASS ]; then
    echo "Shared MySQL database: YES"
    xmlstarlet ed -L -u "advancedsettings/videodatabase/type" -v "mysql" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/videodatabase/host" -v "$KODI_DBHOST" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/videodatabase/user" -v "$KODI_DBUSER" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/videodatabase/pass" -v "$KODI_DBPASS" /config/userdata/advancedsettings.xml
    if [ ! -z $KODI_DBPREFIX_VIDEOS ]; then
      xmlstarlet ed -L -u "advancedsettings/videodatabase/name" -v "$KODI_DBPREFIX_VIDEOS" /config/userdata/advancedsettings.xml
    fi
    xmlstarlet ed -L -u "advancedsettings/musicdatabase/type" -v "mysql" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/musicdatabase/host" -v "$KODI_DBHOST" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/musicdatabase/user" -v "$KODI_DBUSER" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/musicdatabase/pass" -v "$KODI_DBPASS" /config/userdata/advancedsettings.xml
    if [ ! -z $KODI_DBPREFIX_MUSIC ]; then
      xmlstarlet ed -L -u "advancedsettings/musicdatabase/name" -v "$KODI_DBPREFIX_MUSIC" /config/userdata/advancedsettings.xml
    fi
  else
    echo "Shared MySQL database: NO"
    xmlstarlet ed -L -u "advancedsettings/videodatabase/type" -v "sqlite3" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/videodatabase/host" -v "/config/userdata/Database" /config/userdata/advancedsettings.xml

    xmlstarlet ed -L -u "advancedsettings/musicdatabase/type" -v "sqlite3" /config/userdata/advancedsettings.xml
    xmlstarlet ed -L -u "advancedsettings/musicdatabase/host" -v "/config/userdata/Database" /config/userdata/advancedsettings.xml
  fi
else
  echo "Shared MySQL database: UNKNOWN (Using custom advancedsettings.xml)"
fi

if [ -z $KODI_DISABLE_AUDIO ]; then
  KODI_DISABLE_AUDIO="no"
fi

# make sure guisettings/xml exists
if [ ! -e /config/userdata/guisettings.xml ]; then
  if [ ! -d /config/userdata ]; then
    mkdir /config/userdata
  fi
  cp /usr/local/share/kodi/guisettings.xml.default /config/userdata/guisettings.xml
  chown kodi. /config/userdata/guisettings.xml
fi

echo "Set up kodi webserver"
# ensure webserver is enabled
if [ -z "$KODI_WEBSERVER_USERNAME" -o -z "$KODI_WEBSERVER_PASSWORD" ]; then
    xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverauthentication\"]" -v "false" -d "//settings/setting[@id=\"services.webserverauthentication\"]/@default" /config/userdata/guisettings.xml
else
    xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverauthentication\"]" -v "false" -d "//settings/setting[@id=\"services.webserverauthentication\"]/@default" /config/userdata/guisettings.xml
fi
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverpassword\"]" -v "$KODI_WEBSERVER_PASSWORD" -d "//settings/setting[@id=\"services.webserverpassword\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverusername\"]" -v "$KODI_WEBSERVER_USERNAME" -d "//settings/setting[@id=\"services.webserverusername\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserver\"]" -v "true" -d "//settings/setting[@id=\"services.webserver\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverport\"]" -v "8080" -d "//settings/setting[@id=\"services.webserverport\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverssl\"]" -v "false" -d "//settings/setting[@id=\"services.webserverssl\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverpassword\"]" -v "" -d "//settings/setting[@id=\"services.webserverpassword\"]/@default" /config/userdata/guisettings.xml
xmlstarlet ed -L -u "settings/setting[@id=\"services.webserverusername\"]" -v "" -d "//settings/setting[@id=\"services.webserverusername\"]/@default" /config/userdata/guisettings.xml

if [[ $KODI_DISABLE_AUDIO == "yes" ]] || [[ $KODI_DISABLE_AUDIO == "true" ]]; then
    # disable audio output
    echo "Disable audio output"
    xmlstarlet ed -L -u "settings/setting[@id=\"audiooutput.guisoundmode\"]" -v "0" -d "//settings/setting[@id=\"audiooutput.guisoundmode\"]/@default" /config/userdata/guisettings.xml
    xmlstarlet ed -L -u "settings/setting[@id=\"audiooutput.streamnoise\"]" -v "false" -d "//settings/setting[@id=\"audiooutput.streamnoise\"]/@default" /config/userdata/guisettings.xml
    xmlstarlet ed -L -u "settings/setting[@id=\"audiooutput.streamsilence\"]" -v "0" -d "//settings/setting[@id=\"audiooutput.streamsilence\"]/@default" /config/userdata/guisettings.xml
    xmlstarlet ed -L -u "settings/setting[@id=\"lookandfeel.soundskin\"]" -v "" -d "//settings/setting[@id=\"lookandfeel.soundskin\"]/@default" /config/userdata/guisettings.xml
fi
if [ ! -z "$TZ" ]; then
    echo "Adopt timezone from environment"
    xmlstarlet ed -L -u "settings/setting[@id=\"locale.timezone\"]" -v "$TZ" -d "//settings/setting[@id=\"locale.timezone\"]/@default" /config/userdata/guisettings.xml
fi

if [ ! -e /config/.smb/user.conf ]; then
  if [ ! -d /config/.smb ]; then
    mkdir /config/.smb
  fi
  cp /usr/local/share/kodi/smb.conf /config/.smb/user.conf
fi

if [ -z $KODI_UPDATE_INTERVAL ]; then
  KODI_UPDATE_INTERVAL="300"
fi
if [ -z $KODI_CLEAN_INTERVAL ]; then
  KODI_CLEAN_INTERVAL="86400"
fi

function update_library_job {
  while true; do
    sleep $KODI_UPDATE_INTERVAL
    sleep $((RANDOM % 5))
    su kodi -c "kodi-send --action='UpdateLibrary(video)'" > /dev/null
    su kodi -c "kodi-send --action='UpdateLibrary(music)'" > /dev/null
  done
}

function clean_library_job {
  while true; do
    sleep $KODI_CLEAN_INTERVAL
    su kodi -c "kodi-send --action='CleanLibrary(video)'" > /dev/null
    su kodi -c "kodi-send --action='CleanLibrary(music)'" > /dev/null
  done
}

update_library_job &
echo "Automatic library update: YES (${KODI_UPDATE_INTERVAL}s)"

if [[ $KODI_CLEAN == "yes" ]] || [[ $KODI_CLEAN == "true" ]]; then
  if [ -e /config/userdata/sources.xml ] && [ -e /config/userdata/passwords.xml ]; then
    echo "Automatic library cleaning: YES (${KODI_CLEAN_INTERVAL}s)"
    clean_library_job &
  else
    echo "Automatic library cleaning: NO (sources.xml/passwords.xml not found)"
  fi
else
  echo "Automatic library cleaning: NO"
fi


echo "======================================================="

echo "Starting Kodi..."

# make sure the temp directory exists otherwise kodi will crash
if [ ! -d /config/temp ]; then
    mkdir /config/temp
fi
if [ -f /config/temp/kodi.log ]; then
  rm /config/temp/kodi.log
fi

if [ -z $KODI_DEBUG ]; then
  KODI_DEBUG="no"
fi
kodi_debug_opt=''
if [[ $KODI_DEBUG == "yes" ]] || [[ $KODI_DEBUG == "true" ]]; then
    kodi_debug_opt='--debug'
fi

# ensure kodi has full access rights to config
chown kodi. -R /config
tail -F -q /config/temp/kodi.log 2>/dev/null &
exec su kodi -c "kodi -p --standalone --headless $kodi_debug_opt"
